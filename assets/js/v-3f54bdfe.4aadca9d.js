"use strict";(self.webpackChunkweiboqianduan=self.webpackChunkweiboqianduan||[]).push([[5125],{1815:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e={key:"v-3f54bdfe",path:"/JS/ast%E8%AF%AD%E6%B3%95%E5%AE%9E%E6%88%98.html",title:"ast语法实战",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"定义",slug:"定义",children:[]},{level:2,title:"使用的场景",slug:"使用的场景",children:[]},{level:2,title:"js-loader 实战",slug:"js-loader-实战",children:[{level:3,title:"1. 先写一个壳子",slug:"_1-先写一个壳子",children:[]},{level:3,title:"2. 解析字符串",slug:"_2-解析字符串",children:[]},{level:3,title:"3. 解析number",slug:"_3-解析number",children:[]},{level:3,title:"4. 解析其他",slug:"_4-解析其他",children:[]}]},{level:2,title:"css-loader 实战",slug:"css-loader-实战",children:[]},{level:2,title:"参考",slug:"参考",children:[]},{level:2,title:"今日图",slug:"今日图",children:[]}],filePathRelative:"JS/ast语法实战.md",git:{updatedTime:1658471325e3}}},7081:(n,s,a)=>{a.r(s),a.d(s,{default:()=>m});var e=a(6252);const p=(0,e.uE)('<h1 id="ast语法实战" tabindex="-1"><a class="header-anchor" href="#ast语法实战" aria-hidden="true">#</a> ast语法实战</h1><blockquote><p>未完结</p></blockquote><h2 id="定义" tabindex="-1"><a class="header-anchor" href="#定义" aria-hidden="true">#</a> 定义</h2><h2 id="使用的场景" tabindex="-1"><a class="header-anchor" href="#使用的场景" aria-hidden="true">#</a> 使用的场景</h2><p>写 <code>loader</code> <code>plugin</code> <code>eslint</code> 等</p><h2 id="js-loader-实战" tabindex="-1"><a class="header-anchor" href="#js-loader-实战" aria-hidden="true">#</a> js-loader 实战</h2><h3 id="_1-先写一个壳子" tabindex="-1"><a class="header-anchor" href="#_1-先写一个壳子" aria-hidden="true">#</a> 1. 先写一个壳子</h3><p>假设现在要写一个解析js的 <code>loader</code></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// loader.js</span>\n<span class="token keyword">const</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/generator&#39;</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/parser&#39;</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/traverse&#39;</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/types&#39;</span><span class="token punctuation">)</span>\n<span class="token keyword">function</span> <span class="token function">compile</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">//   1. 解析为AST</span>\n  <span class="token keyword">const</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">sourceType</span><span class="token operator">:</span> <span class="token string">&#39;module&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token comment">//visitor可以对特定节点进行处理</span>\n  <span class="token keyword">const</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token punctuation">}</span>\n  traverse<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> visitor<span class="token punctuation">)</span>\n  <span class="token comment">//   2. 生成代码片段</span>\n  <span class="token keyword">return</span> generator<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">compile</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span>code\n<span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>\n<span class="token comment">// main.js 假设解析此文件</span>\n<span class="token keyword">const</span> imgPath <span class="token operator">=</span> <span class="token string">&#39;/assets/image/aa.png&#39;</span>\n<span class="token keyword">const</span> imgPath1 <span class="token operator">=</span> <span class="token number">123</span>\n<span class="token keyword">const</span> imgPatharr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">const</span> imgPath2 <span class="token operator">=</span> <span class="token string">&#39;sfdgsdf&#39;</span>\n<span class="token keyword">const</span> imgPath3 <span class="token operator">=</span> <span class="token boolean">true</span>\n<span class="token keyword">function</span> <span class="token function">test</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token number">456</span>\n<span class="token punctuation">}</span>\n<span class="token function">test</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n\n\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>webpack.base.conf.js</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>{\n    rules: [\n      {\n        test: /\\.js$/,\n        include: [\n          resolve(&#39;src&#39;)\n        ],\n        use: [\n          {\n            loader: &#39;babel-loader&#39;\n          },\n          {\n            loader: path.resolve(__dirname, &#39;./loader.js&#39;)\n          }\n        ]\n      }\n    ]\n}\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_2-解析字符串" tabindex="-1"><a class="header-anchor" href="#_2-解析字符串" aria-hidden="true">#</a> 2. 解析字符串</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// loader.js</span>\n<span class="token keyword">const</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function">StringLiteral</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> <span class="token punctuation">{</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">.</span>node <span class="token comment">// 找到所有定义的字符串</span>\n      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>value <span class="token operator">=</span> value <span class="token operator">+</span> <span class="token number">12333</span> <span class="token comment">// 进行修改，会匹配到 /assets/image/aa.png sfdgsdf,最后我们可以做想要的处理</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>比如我们想找到项目中所有的图片，比如找到了一个 <code>/assets/image/aa.png</code> ，我们可以进行替换2倍图(<code>/assets/image/aa@2x.png</code>)，或者转换webp(<code>/assets/image/aa.png.webp</code>)等</li><li>也可以再此进行网络请求获取此图片，进行压缩获取缩略图，最终再 <code>img</code> 标签(也可以封装一个成熟的组件封装此繁琐功能)再图片未加载完毕利用分割获取到 <code>base64</code> 让用户先看到模糊的图片外加高斯模糊，图片加载完毕替换即可，例如拼在 <code>/assets/image/aa.png?$-$data:image/jpg;base64,/9j/ffa……</code></li></ul><h3 id="_3-解析number" tabindex="-1"><a class="header-anchor" href="#_3-解析number" aria-hidden="true">#</a> 3. 解析number</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// loader.js</span>\n<span class="token keyword">const</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function">NumericLiteral</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> <span class="token punctuation">{</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">.</span>node\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">// 可以找出所有的number 123 456 9 1 2 3</span>\n    path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>value <span class="token operator">=</span> value <span class="token operator">+</span> <span class="token number">12333</span> \n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_4-解析其他" tabindex="-1"><a class="header-anchor" href="#_4-解析其他" aria-hidden="true">#</a> 4. 解析其他</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">const</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function">BooleanLiteral</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n      <span class="token keyword">let</span> <span class="token punctuation">{</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">.</span>node\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;BooleanLiteral&#39;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n      <span class="token comment">// path.node.value = false;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">BigIntLiteral</span>  <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n      <span class="token keyword">let</span> <span class="token punctuation">{</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">.</span>node\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;BigIntLiteral&#39;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="css-loader-实战" tabindex="-1"><a class="header-anchor" href="#css-loader-实战" aria-hidden="true">#</a> css-loader 实战</h2><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> csstree <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;css-tree&#39;</span><span class="token punctuation">)</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// parse CSS to AST</span>\n  <span class="token keyword">const</span> ast <span class="token operator">=</span> csstree<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// traverse AST and modify it</span>\n  csstree<span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> item<span class="token punctuation">,</span> aa</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;type&#39;</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>type<span class="token punctuation">)</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>name<span class="token punctuation">)</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;value&#39;</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;ClassSelector&#39;</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;h2&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      node<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;hello&#39;</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// generate CSS from AST</span>\n  <span class="token keyword">return</span> csstree<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="参考" tabindex="-1"><a class="header-anchor" href="#参考" aria-hidden="true">#</a> 参考</h2>',22),t={href:"https://github.com/jamiebuilds/babel-handbook/blob/master/translations/en/plugin-handbook.md#babel-traverse",target:"_blank",rel:"noopener noreferrer"},o=(0,e.Uk)("babel-traverse"),c={href:"https://www.babeljs.cn/docs/babel-traverse",target:"_blank",rel:"noopener noreferrer"},l=(0,e.Uk)("babel-traverse"),r={href:"https://babel.dev/docs/en/babel-types",target:"_blank",rel:"noopener noreferrer"},u=(0,e.Uk)("babel-types"),i=(0,e._)("li",null,"https://juejin.cn/post/7007725841689870366",-1),k=(0,e._)("li",null,"https://zhuanlan.zhihu.com/p/183919769",-1),b=(0,e._)("h2",{id:"今日图",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#今日图","aria-hidden":"true"},"#"),(0,e.Uk)(" 今日图")],-1),d={},m=(0,a(3744).Z)(d,[["render",function(n,s){const a=(0,e.up)("OutboundLink");return(0,e.wg)(),(0,e.iD)(e.HY,null,[p,(0,e._)("ul",null,[(0,e._)("li",null,[(0,e._)("a",t,[o,(0,e.Wm)(a)])]),(0,e._)("li",null,[(0,e._)("a",c,[l,(0,e.Wm)(a)])]),(0,e._)("li",null,[(0,e._)("a",r,[u,(0,e.Wm)(a)])]),i,k]),b],64)}]])}}]);